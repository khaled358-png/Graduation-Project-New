- name: Provision server for Restaurant Node App
  hosts: all
  become: yes

  vars:
    app_name: "restaurant-app"
    app_port: 3000
    app_repo: "https://github.com/khaled358-png/Graduation-Project-New.git"
    app_dir: "/opt/restaurant-app"

  tasks:

    # 1) Install system dependencies
    - name: Install required system packages
      apt:
        name:
          - python3
          - python3-pip
          - curl
          - git
        state: present
        update_cache: yes

    # 2) Add deploy public key to EC2 user
    - name: Add deploy public key to EC2 user
      authorized_key:
        user: ubuntu                 
        state: present
        key: "{{ lookup('file', '~/.ssh/deploy_key.pub') }}"

    # 3) Install Docker
    - name: Install Docker using official script
      shell: curl -fsSL https://get.docker.com | sh
      args:
        warn: false

    # 4) Ensure Docker is running
    - name: Ensure Docker service is enabled and started
      service:
        name: docker
        state: started
        enabled: yes
